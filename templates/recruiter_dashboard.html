<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Recruiter Dashboard | CareerConnect</title>
    <!-- Bootstrap CDN -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
  </head>
  <body style="background: #f5f7fb;">
    <!-- Top Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top" style="z-index: 1020;">
      <div class="container-fluid">
        <a class="navbar-brand fw-bold text-primary" href="{{ url_for('recruiter_dashboard') }}">CareerConnect</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#recruiterNav" aria-controls="recruiterNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="recruiterNav">
          <div class="ms-auto d-flex gap-2 align-items-center">
            <span class="text-muted me-3">
              <small id="notifications" style="cursor: pointer; text-decoration: underline;">
                <span id="notification-count">0</span> new applications
              </small>
            </span>
            <a class="btn btn-outline-danger btn-sm" href="{{ url_for('logout') }}">Logout</a>
          </div>
        </div>
      </div>
    </nav>

    <div class="container-fluid py-4">
      <!-- Header -->
      <div class="d-flex flex-wrap align-items-center justify-content-between mb-4 gap-3">
        <div>
          <h2 class="mb-1">
            Welcome back,
            <span class="text-primary">{{ profile.company_name or profile.username or 'Recruiter' }}</span>
          </h2>
          <p class="text-muted mb-0">Post jobs, review candidates, and manage your hiring pipeline</p>
        </div>
        <div class="d-flex gap-2">
          <a class="btn btn-outline-primary" href="{{ url_for('recruiter_profile') }}">Edit Profile</a>
          <a class="btn btn-primary" href="{{ url_for('post_job') }}">Post Job</a>
        </div>
      </div>

      <div class="row g-4">
        <!-- Company Profile Summary -->
        <div class="col-xl-3 col-lg-4" id="company-profile">
          <div class="card h-100 shadow-sm">
            <div class="card-body">
              <div class="d-flex align-items-center mb-3">
                <div class="rounded-circle bg-primary bg-opacity-10 text-primary d-flex align-items-center justify-content-center" style="width: 48px; height: 48px; font-weight: 700;">
                  {{ (profile.company_name or profile.username or 'CC')[:2]|upper if profile else 'CC' }}
                </div>
                <div class="ms-3">
                  <h5 class="mb-0">{{ profile.company_name or 'Your Company' }}</h5>
                  <small class="text-muted">{{ profile.industry_type or 'Industry' }}</small>
                </div>
              </div>
              <ul class="list-unstyled mb-3 small text-muted">
                <li class="mb-1">Username: {{ profile.username or '-' }}</li>
                <li class="mb-1">Location: {{ profile.company_location or '-' }}</li>
                <li class="mb-1">Industry: {{ profile.industry_type or '-' }}</li>
                <li class="mb-1">Active Job Postings: <strong id="active-postings">{{ job_postings|length if job_postings else 0 }}</strong></li>
              </ul>
              <a class="btn btn-outline-primary w-100" href="{{ url_for('recruiter_profile') }}">View / Edit Profile</a>
            </div>
          </div>
        </div>

        <!-- Hiring Metrics & Quick Actions -->
        <div class="col-xl-9 col-lg-8">
          <div class="row g-4">
            <!-- Key Metrics -->
            <div class="col-md-6">
              <div class="card h-100 shadow-sm">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-start mb-3">
                    <h5 class="mb-0">Hiring Pipeline</h5>
                    <span class="badge bg-primary bg-opacity-10 text-primary">This Month</span>
                  </div>
                  <div class="row g-3 small">
                    <div class="col-4">
                      <div class="text-muted">Active Postings</div>
                      <div class="display-6 fw-bold text-primary" id="total-postings">{{ active_postings_count if active_postings_count is defined else (job_postings|length if job_postings else 0) }}</div>
                    </div>
                    <div class="col-4">
                      <div class="text-muted">Total Applications</div>
                      <div class="display-6 fw-bold text-secondary" id="total-applications">{{ total_applications }}</div>
                    </div>
                    <div class="col-4">
                      <div class="text-muted">Shortlisted</div>
                      <div class="display-6 fw-bold text-info" id="shortlisted-count">{{ shortlisted_count }}</div>
                    </div>
                    <div class="col-4">
                      <div class="text-muted">Rejected</div>
                      <div class="display-6 fw-bold text-danger" id="rejected-count">{{ rejected_count }}</div>
                    </div>
                    <div class="col-4">
                      <div class="text-muted">Hired</div>
                      <div class="display-6 fw-bold text-success" id="hired-count">{{ hired_count }}</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Quick Actions -->
            <div class="col-md-6">
              <div class="card h-100 shadow-sm">
                <div class="card-body">
                  <h5 class="mb-3">Quick Actions</h5>
                  <div class="d-grid gap-2">
                    <a class="btn btn-primary" href="{{ url_for('post_job') }}">Post New Job</a>
                    <a class="btn btn-outline-primary" href="{{ url_for('all_candidates') }}">View All Candidates</a>
                    <a class="btn btn-outline-primary" href="{{ url_for('all_shortlisted') }}">Shortlisted Candidates</a>
                    <a class="btn btn-outline-primary" href="{{ url_for('analytics') }}">View Analytics</a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Active Job Postings -->
      <div class="card mt-4 shadow-sm" id="active-jobs">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Active Job Postings</h5>
            <div class="d-flex gap-2">
              <select class="form-select form-select-sm" id="sortBy" style="width: 180px;" onchange="handleSort()">
                <option value="recent" selected>Sort by: Recently Posted</option>
                <option value="applications">Most Applications</option>
                <option value="title">Job Title</option>
              </select>
              <input class="form-control form-control-sm" id="filterInput" style="width: 200px;" placeholder="Filter by job title" />
            </div>
          </div>
          <div class="row g-3" id="job-postings-container">
            <!-- Job posting cards will be dynamically loaded here -->
            {% if job_postings and job_postings|length > 0 %}
              {% for job in job_postings %}
              <div class="col-lg-4 col-md-6">
                <div class="card h-100 border-0 shadow-sm" onclick="window.location.href='{{ url_for('job_details', job_id=job.id) }}'" style="cursor: pointer;">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                      <div>
                        <h6 class="mb-1"><a href="{{ url_for('job_details', job_id=job.id) }}" class="text-decoration-none text-dark">{{ job.job_title }}</a></h6>
                        <small class="text-muted">{{ job.job_location }}</small>
                      </div>
                      {% if job.is_active == 1 %}
                        <span class="badge bg-success">Active</span>
                      {% else %}
                        <span class="badge bg-secondary">Inactive</span>
                      {% endif %}
                    </div>
                    <p class="small text-muted mt-2 mb-2"><strong>Experience:</strong> {{ job.experience_level }}</p>
                    <p class="small text-muted mb-2"><strong>Type:</strong> {{ job.employment_type }}</p>
                    {% if job.salary_range %}
                    <p class="small text-muted mb-2"><strong>Salary:</strong> {{ job.salary_range }}</p>
                    {% endif %}
                    <p class="small text-muted mb-2"><strong>Skills:</strong> {{ job.required_skills }}</p>
                    <div class="d-flex flex-wrap gap-2">
                      <a class="btn btn-sm btn-primary" href="{{ url_for('recruiter_job_applications', job_id=job.id) }}" onclick="event.stopPropagation();">View Applications</a>
                      <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('edit_job', job_id=job.id) }}" onclick="event.stopPropagation();">Edit</a>
                      <form method="POST" action="{{ url_for('toggle_job_active', job_id=job.id) }}" style="display:inline;" onclick="event.stopPropagation();">
                        <button type="submit" class="btn btn-sm {{ 'btn-outline-warning' if job.is_active == 1 else 'btn-outline-success' }}">{{ 'Deactivate' if job.is_active == 1 else 'Activate' }}</button>
                      </form>
                      <form method="POST" action="{{ url_for('delete_job', job_id=job.id) }}" style="display:inline;" onclick="event.stopPropagation();" onsubmit="return confirm('Delete this job? This cannot be undone.');">
                        <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            {% else %}
              <div class="col-12">
                <p class="text-muted text-center py-4">No active job postings yet. <a href="{{ url_for('post_job') }}">Post a job now</a></p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Recent Applications & Candidates -->
      <div class="row g-4 mt-1">
        <div class="col-lg-8" id="applications">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Recent Applications</h5>
                <select class="form-select form-select-sm" id="applicationsStatusFilter" style="width: 180px;">
                  <option value="all" selected>All statuses</option>
                  <option value="applied">New</option>
                  <option value="shortlisted">Shortlisted</option>
                  <option value="rejected">Rejected</option>
                  <option value="hired">Hired</option>
                </select>
              </div>
              <div class="table-responsive">
                <table class="table align-middle mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>Candidate</th>
                      <th>Job Role</th>
                      <th>Status</th>
                      <th>Applied</th>
                      <th>Match %</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody id="applications-tbody">
                    {% if applications and applications|length > 0 %}
                      {% for app in applications %}
                      <tr data-status="{{ app.status }}">
                        <td>{{ app.candidate_name }}</td>
                        <td>{{ app.job_title }}</td>
                        <td>
                          {% if app.status == 'applied' %}
                            <span class="badge bg-secondary">New</span>
                          {% elif app.status == 'shortlisted' %}
                            <span class="badge bg-info text-dark">Shortlisted</span>
                          {% elif app.status == 'rejected' %}
                            <span class="badge bg-danger">Rejected</span>
                          {% elif app.status == 'hired' %}
                            <span class="badge bg-success">Hired</span>
                          {% endif %}
                        </td>
                        <td><small class="text-muted">{{ app.applied_at[:10] if app.applied_at else '-' }}</small></td>
                        <td>
                          {% if application_match_scores and app.id in application_match_scores %}
                            <span class="badge bg-success">{{ application_match_scores[app.id] }}%</span>
                          {% else %}
                            <span class="badge bg-secondary">--</span>
                          {% endif %}
                        </td>
                        <td>
                          <a href="{{ url_for('view_candidate', seeker_user_id=app.seeker_user_id, application_id=app.id) }}" class="btn btn-sm btn-outline-primary">View Resume</a>
                        </td>
                      </tr>
                      {% endfor %}
                    {% else %}
                      <tr>
                        <td colspan="6" class="text-muted text-center py-4">No applications yet</td>
                      </tr>
                    {% endif %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Shortlisted Candidates -->
        <div class="col-lg-4" id="shortlisted">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <h5 class="mb-3">Shortlisted Candidates</h5>
              <div class="list-group small" id="shortlisted-list">
                {% if shortlisted_candidates and shortlisted_candidates|length > 0 %}
                  {% for sc in shortlisted_candidates %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                      <div style="flex: 1;">
                        <div class="fw-semibold">{{ sc.candidate_name }}</div>
                        <div class="text-muted small">{{ sc.job_title }} â€¢ {{ sc.applied_at[:10] if sc.applied_at else '-' }}</div>
                        {% if shortlisted_ats_scores and sc.id in shortlisted_ats_scores %}
                          <div class="mt-1"><span class="badge bg-success">ATS: {{ shortlisted_ats_scores[sc.id] }}</span></div>
                        {% endif %}
                      </div>
                      <a class="btn btn-sm btn-outline-primary ms-2" href="{{ url_for('view_candidate', seeker_user_id=sc.seeker_user_id) }}?application_id={{ sc.id }}">View</a>
                    </div>
                  {% endfor %}
                {% else %}
                  <p class="text-muted text-center py-4">No shortlisted candidates yet</p>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>

    <script>
      // Initialize recruiter dashboard
      document.addEventListener('DOMContentLoaded', function() {
        // TODO: Load metrics from backend
        // TODO: Load job postings from backend
        // TODO: Load recent applications from backend
        // TODO: Load shortlisted candidates from backend
      });

      // Handle sort dropdown with AJAX
      function handleSort() {
        const sortValue = document.getElementById('sortBy').value;
        
        fetch(`{{ url_for('get_jobs') }}?sort=${sortValue}`)
          .then(response => response.json())
          .then(data => {
            const container = document.getElementById('job-postings-container');
            
            if (data.jobs && data.jobs.length > 0) {
              let html = '';
              data.jobs.forEach(job => {
                const statusBadge = job.is_active === 1 
                  ? '<span class="badge bg-success">Active</span>'
                  : '<span class="badge bg-secondary">Inactive</span>';
                const jobDetailsUrl = `/job/${job.id}`;
                const viewAppUrl = `/recruiter/job/${job.id}/applications`;
                const editUrl = `/recruiter/edit_job/${job.id}`;
                const toggleUrl = `/recruiter/toggle_job_active/${job.id}`;
                const deleteUrl = `/recruiter/delete_job/${job.id}`;
                  
                html += `
                  <div class="col-lg-4 col-md-6">
                    <div class="card h-100 border-0 shadow-sm" onclick="window.location.href='${jobDetailsUrl}'" style="cursor: pointer;">
                      <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                          <div>
                            <h6 class="mb-1"><a href="${jobDetailsUrl}" class="text-decoration-none text-dark">${job.job_title}</a></h6>
                            <small class="text-muted">${job.job_location}</small>
                          </div>
                          ${statusBadge}
                        </div>
                        <p class="small text-muted mt-2 mb-2"><strong>Experience:</strong> ${job.experience_level}</p>
                        <p class="small text-muted mb-2"><strong>Type:</strong> ${job.employment_type}</p>
                        ${job.salary_range ? `<p class="small text-muted mb-2"><strong>Salary:</strong> ${job.salary_range}</p>` : ''}
                        <p class="small text-muted mb-2"><strong>Skills:</strong> ${job.required_skills}</p>
                        <div class="d-flex flex-wrap gap-2">
                          <a class="btn btn-sm btn-primary" href="${viewAppUrl}" onclick="event.stopPropagation();">View Applications</a>
                          <a class="btn btn-sm btn-outline-secondary" href="${editUrl}" onclick="event.stopPropagation();">Edit</a>
                          <form method="POST" action="${toggleUrl}" style="display:inline;" onclick="event.stopPropagation();">
                            <button type="submit" class="btn btn-sm ${job.is_active === 1 ? 'btn-outline-warning' : 'btn-outline-success'}">${job.is_active === 1 ? 'Deactivate' : 'Activate'}</button>
                          </form>
                          <form method="POST" action="${deleteUrl}" style="display:inline;" onclick="event.stopPropagation();" onsubmit="return confirm('Delete this job? This cannot be undone.');">
                            <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>
                `;
              });
              container.innerHTML = html;
            } else {
              container.innerHTML = '<div class="col-12"><p class="text-muted text-center py-4">No jobs found.</p></div>';
            }
          })
          .catch(error => console.error('Error fetching jobs:', error));
      }

      // Handle filter input (client-side filtering)
      document.getElementById('filterInput').addEventListener('keyup', function() {
        const filterValue = this.value.toLowerCase();
        const jobCards = document.querySelectorAll('#job-postings-container .col-lg-4');
        
        jobCards.forEach(card => {
          const jobTitle = card.querySelector('h6 a').textContent.toLowerCase();
          if (jobTitle.includes(filterValue)) {
            card.style.display = '';
          } else {
            card.style.display = 'none';
          }
        });
      });

      // Applications status filter (client-side)
      (function() {
        const statusFilter = document.getElementById('applicationsStatusFilter');
        if (!statusFilter) return;

        statusFilter.addEventListener('change', function() {
          const value = this.value; // 'all', 'applied', 'shortlisted', 'rejected', 'hired'
          const rows = document.querySelectorAll('#applications-tbody tr');
          rows.forEach(row => {
            const status = row.getAttribute('data-status');
            if (value === 'all' || status === value) {
              row.style.display = '';
            } else {
              row.style.display = 'none';
            }
          });
        });
      })();
    </script>
  </body>
</html>


